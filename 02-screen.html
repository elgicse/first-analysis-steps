<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>LHCb Starterkit: First Steps in LHCb</title>
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" type="text/css" href="css/bootstrap/bootstrap.css" />
    <link rel="stylesheet" type="text/css" href="css/bootstrap/bootstrap-theme.css" />
    <link rel="stylesheet" type="text/css" href="css/swc.css" />
    <meta charset="UTF-8" />
    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <script>
     (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
     (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
     m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
     })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
     ga('create', 'UA-63818884-1', 'auto');
     ga('send', 'pageview');
    </script>
  </head>
  <body class="lesson">
    <div class="container card">
      <div class="banner">
        <a href="https://lhcb.github.io/first-analysis-steps/">
          <img src="img/starterkit.png" height="100" alt="LHCb Starterkit">
        </a>
      </div>
      <div class="row">
        <div class="col-md-10 col-md-offset-1">
          <h1 class="title">First Steps in LHCb</h1>
          <h2 class="subtitle">Using screen to keep things running</h2>
<div id="learning-objectives" class="objectives panel panel-warning">
<div class="panel-heading">
<h2><span class="glyphicon glyphicon-certificate"></span>Learning Objectives</h2>
</div>
<div class="panel-body">
<ul>
<li>Create a new <code>screen</code> session</li>
<li>Disconnect from a <code>screen</code> session</li>
<li>Reconnect to an existing <code>screen</code> session</li>
<li>End an existing <code>screen</code> session</li>
<li>Handling of Kerberos tokens</li>
</ul>
</div>
</div>
<p>Often we want to run a program for a long time on a computer we connected to via <code>ssh</code>, like the <code>lxplus</code> machines. The <code>screen</code> program allows you to keep programs running on the remote computer even if you disconnect from it. For example when putting your laptop to sleep or losing wifi.</p>
<p>Connect to <code>lxplus</code>:</p>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">ssh</span> lxplus.cern.ch</code></pre>
<p>You can start <code>screen</code> by simply typing its name:</p>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">screen</span></code></pre>
<p>Once you do this it will look as if nothing has happened. However you now have a fresh terminal inside what is refered to as a &quot;screen session&quot;. Let's type some commands that generate some output:</p>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">uptime</span></code></pre>
<pre class="output"><code> 11:48:02 up 15 days, 20:36, 105 users,  load average: 2.26, 2.10, 3.16</code></pre>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">date</span></code></pre>
<pre class="output"><code>Thu Apr 16 11:48:32 CEST 2015</code></pre>
<p>To disconnect from this session press <code>Ctrl-a d</code>. We are now back to the terminal that we first started in. You can check that your <code>screen</code> session is still running by typing <code>screen -list</code>, which will list all active sessions:</p>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">screen</span> -list</code></pre>
<pre class="output"><code>There is a screen on:
      25593.pts-44.lxplus0234   (Detached)
1 Socket in /var/run/screen/S-thead.</code></pre>
<p>To reconnect to the session you use <code>screen -rD</code>. When there is just one session running (like now) then it will reconnect you to that session. Try it and you should see the date and time output by the <code>date</code> command we ran earlier.</p>
<p>When you have more than one session you need to provide the name of the session as an argument to <code>screen -rD</code>. The name of the above session is: <code>25593.pts-44.lxplus0234</code>. You can reconnect to it with:</p>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">screen</span> -rD 25593.pts-44.lxplus0234</code></pre>
<p>To end a <code>screen</code> session you are currently connected to, simply press <code>Ctrl-d</code>. Just like you would to disconnect from a <code>ssh</code> session.</p>
<p>A <code>screen</code> session is tied to a specific computer. This means you need to remember which computer you connected to. Even if your <code>screen</code> session keeps running, you can only resume it from the same machine as you started it.</p>
<p>When connecting to <code>lxplus</code> you are assigned to a random computer, but you can find out its name with <code>hostname</code>:</p>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">hostname</span></code></pre>
<pre class="output"><code>lxplus0081.cern.ch</code></pre>
<p>This tells you that the computer you are connected to is called <code>lxplus0081.cern.ch</code>. Later on you can re-connect to exactly this machine with:</p>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">ssh</span> lxplus0081.cern.ch</code></pre>
<p>Another complication are your kerberos tokens. These typically expire as soon as you disconnect from a <code>lxplus</code> machine. This means the program you left running inside the <code>screen</code> session will suddenly not be able to write to any files in your home directory anymore. This is particularly annoying if you are running <code>ganga</code> in your screen session.</p>
<p>One way to stop your tokens from expiring is to type <code>kinit</code> when you first start a new <code>screen</code> session. The tokens you get this way will survive you disconnecting. However they will expire after 24 hours, so you will have to type <code>kinit</code> again to renew them if you leave <code>screen</code> running for longer than 24 hours.</p>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">screen</span>
<span class="co"># now inside the screen session</span>
$ <span class="kw">kinit</span></code></pre>
<div id="finding-lost-screens" class="callout panel panel-info">
<div class="panel-heading">
<h2><span class="glyphicon glyphicon-pushpin"></span>Finding lost screens</h2>
</div>
<div class="panel-body">
<p>Once you start a <code>screen</code> session you need to remember which <code>lxplus</code> node it is running on. If you forget to note that down you can use the following little snippet to find any <code>screen</code> sessions running on <code>lxplus</code> nodes:</p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">for</span> <span class="kw">i</span> in <span class="ot">$(</span><span class="kw">seq</span> -f <span class="st">&quot;%04g&quot;</span> 1 500<span class="ot">)</span><span class="kw">;</span> <span class="kw">do</span>
 <span class="kw">ssh</span> -o ConnectTimeout=10 -o PreferredAuthentications=gssapi-with-mic,gssapi -o GSSAPIAuthentication=yes -o StrictHostKeyChecking=no -o LogLevel=quiet lxplus<span class="ot">$i</span>.cern.ch <span class="st">&quot;(screen -list | head -1 | grep -q &#39;There is a screen on&#39;) &amp;&amp; hostname &amp;&amp; screen -list&quot;</span>
<span class="kw">done</span></code></pre>
<p>This will connect to the first 500 lxplus nodes in turn, checking if a <code>screen</code> session is running and if yes prints the hostname and output of <code>screen -list</code>.</p>
</div>
</div>
<div id="using-tabs-in-screen" class="callout panel panel-info">
<div class="panel-heading">
<h2><span class="glyphicon glyphicon-pushpin"></span>Using tabs in screen</h2>
</div>
<div class="panel-body">
<p>Screen supports some features beyond detaching a session. A very useful feature is different sessions in tab pages, all within a single instance of <code>screen</code>. In order to maximise the usefulness of this feature, you need to set the screen status bar. The simplest way to do this is by appending the following line to the file <code>~/.screenrc</code> (create it if it doesn't already exist):</p>
<pre><code># Status lines
hardstatus off
hardstatus alwayslastline
hardstatus string &#39;%{= BG}%{.g}[ %{.G}%H %{.g}][ %{= Bw}%?%-Lw%?%{Yr}%{.k}%n*%f%? %t%?%?(%u)%?%{.r}%{Bw}%?%+Lw%? %{.g}%=][%{.W} %Y-%m-%d %c %{.g}]&#39;</code></pre>
<p>Note that this has predefined colours and layout that you can easily change yourself, see eg. this <a href="http://sourceopen.com/2014/06/09/gnu-screen-status-bar-tips-tricks-basics/">detailed discussion</a>.</p>
<p>The following commands should help you get started using multiple tabs in a screen window. Note that <code>^a</code> stands for <code>Ctrl-a</code> in this list. * Create a new tab: <code>^a c</code> * Switch to tab number #: <code>^a #</code> (where # is a digit) * Switch to the last visited tab: <code>^a ^a</code> * Close a tab: log out of the shell with <code>^d</code> * Kill a tab: <code>^a k</code> (only use if normal logout through <code>^d</code> doesn't work because a process has crashed) * Change a tab's name: <code>^a A</code></p>
<p>As one last note, you may find it easier if the tab numbers start with 1, rather than 0. To accomplish this, append the following lines to the aforementioned file <code>~/.screenrc</code>:</p>
<pre><code># Start with window 1 (instead of 0)
bind c screen 1
bind ^c screen 1
bind 0 select 10
screen 1</code></pre>
</div>
</div>
        </div>
      </div>
      <div class="footer">
        <a class="label swc-blue-bg" href="http://software-carpentry.org">Software Carpentry</a>
        <a class="label swc-blue-bg" href="https://github.com/lhcb/first-analysis-steps">Source</a>
        <a class="label swc-blue-bg" href="mailto:lhcb-starterkit@cern.ch">Contact</a>
        <a class="label swc-blue-bg" href="LICENSE.html">License</a>
      </div>
    </div>
    <!-- Javascript placed at the end of the document so the pages load faster -->
    <script src="http://software-carpentry.org/v5/js/jquery-1.9.1.min.js"></script>
    <script src="css/bootstrap/bootstrap-js/bootstrap.js"></script>
  </body>
</html>
